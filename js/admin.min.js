const productForm=document.getElementById("productForm"),submitBtn=document.getElementById("submitBtn"),clearBtn=document.getElementById("clearBtn"),productsTable=document.getElementById("productsTable"),searchInput=document.getElementById("search"),importForm=document.getElementById("importForm"),salesTable=document.getElementById("salesTable"),salesSearch=document.getElementById("salesSearch"),toggleScanner=document.getElementById("toggleScanner"),barcodeScanner=document.getElementById("barcode-scanner"),scanResult=document.getElementById("scanResult"),thresholdForm=document.getElementById("thresholdForm"),lowStockTable=document.getElementById("lowStockTable"),reportForm=document.getElementById("reportForm"),reportTable=document.getElementById("reportTable"),exportReportCsv=document.getElementById("exportReportCsv");let csrfToken=document.getElementById("csrf_token").value,hasAlerted=false,salesChart=null,scannerActive=false,searchTimeout=null;function showError(e,t,r){e.innerHTML=`<tr><td colspan="${r}" class="error">Error: ${t}</td></tr>`}function updateCsrfToken(){fetch("api.php?action=get_new_csrf_token").then(e=>e.json()).then(e=>{csrfToken=e.csrf_token,document.getElementById("csrf_token").value=e.csrf_token}).catch(e=>console.error("CSRF token error:",e))}function fetchSalesReport(e,t,r=!1){reportTable.innerHTML='<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>',fetch(`api.php?action=get_sales_report&start_date=${e}&end_date=${t}`).then(e=>e.json()).then(n=>{if(n.status==="error")throw new Error(n.message);reportTable.innerHTML="";let i=0,o=0,a=0;n.length===0?reportTable.innerHTML="<tr><td colspan=4>No sales data for this period.</td></tr>":n.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`<td>${e.sale_day}</td><td>${e.sales_count}</td><td>${e.items_sold}</td><td>$${parseFloat(e.revenue).toFixed(2)}</td>`,reportTable.appendChild(t),i+=parseInt(e.sales_count),o+=parseInt(e.items_sold),a+=parseFloat(e.revenue)}),document.getElementById("totalSales").textContent=i,document.getElementById("totalItems").textContent=o,document.getElementById("totalRevenue").textContent=`$${a.toFixed(2)}`,salesChart&&salesChart.destroy(),salesChart=new Chart(document.getElementById("salesChart"),{type:"bar",data:{labels:n.map(e=>e.sale_day),datasets:[{label:"Daily Revenue ($)",data:n.map(e=>parseFloat(e.revenue)),backgroundColor:"rgba(54,162,235,0.6)",borderColor:"rgba(54,162,235,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,title:{display:!0,text:"Revenue ($)"}},x:{title:{display:!0,text:"Date"}}},plugins:{legend:{display:!0,position:"top"}}}}),exportReportCsv.href=`api.php?action=export_sales_report_csv&start_date=${e}&end_date=${t}`,r&&alert("Sales report generated")}).catch(e=>{console.error("Sales report error:",e),showError(reportTable,e.message,4)})}function fetchLowStockProducts(){lowStockTable.innerHTML='<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>',fetch("api.php?action=get_low_stock_products").then(e=>e.json()).then(e=>{if(e.status==="error")throw new Error(e.message);lowStockTable.innerHTML="",e.length===0?lowStockTable.innerHTML="<tr><td colspan=6>No low stock products.</td></tr>":e.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`<td>${e.id}</td><td>${e.name}</td><td>$${parseFloat(e.price).toFixed(2)}</td><td>${e.quantity}</td><td>${e.category_name||"N/A"}</td><td>${e.barcode}</td>`,lowStockTable.appendChild(t)}),!hasAlerted&&e.length>0&&(alert(`Warning: ${e.length} product(s) have low stock (quantity â‰¤ ${document.getElementById("low_stock_threshold").value}). Check Low Stock Alerts.`),hasAlerted=!0)}).catch(e=>{console.error("Low stock error:",e),showError(lowStockTable,e.message,6)})}function fetchProducts(e=""){productsTable.innerHTML='<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>',fetch(`api.php?action=get_products&search=${encodeURIComponent(e)}`).then(e=>e.json()).then(t=>{if(t.status==="error")throw new Error(t.message);productsTable.innerHTML="",t.forEach(t=>{const r=document.createElement("tr");t.is_low_stock==1&&r.classList.add("low-stock"),r.innerHTML=`<td>${t.id}</td><td>${t.name}</td><td>$${parseFloat(t.price).toFixed(2)}</td><td>${t.quantity}</td><td>${t.category_name||"N/A"}</td><td>${t.barcode}</td><td>${t.image?`<img src="/POS/Uploads/${t.image}" width="50" loading="lazy" alt="Product Image">`:"No Image"}</td><td><button class="btn btn-sm btn-warning me-1" onclick="editProduct(${t.id},'${t.name.replace(/'/g,"\\'")}',${t.price},${t.quantity},${t.category_id},'${t.description?t.description.replace(/'/g,"\\'"):""}','${t.barcode}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="deleteProduct(${t.id})"><i class="fas fa-trash"></i></button></td>`,productsTable.appendChild(r)})}).catch(t=>{console.error("Products error:",t),showError(productsTable,t.message,8)})}function generateInvoice(e){fetch("api.php?action=generate_invoice",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sale_id:e,csrf_token:csrfToken})}).then(e=>e.ok?e.blob():e.json().then(t=>{throw new Error(t.message||"Failed to generate invoice")})).then(t=>{const r=window.URL.createObjectURL(t),n=document.createElement("a");n.href=r,n.download=`INV-${e}.pdf`,document.body.appendChild(n),n.click(),n.remove(),window.URL.revokeObjectURL(r),updateCsrfToken(),alert("Invoice generated")}).catch(t=>{console.error("Invoice error:",t),alert(`Error: ${t.message}`)})}function fetchSales(e=""){salesTable.innerHTML='<tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>',fetch(`api.php?action=get_sales${e?`&search=${encodeURIComponent(e)}`:""}`).then(e=>e.json()).then(t=>{if(t.status==="error")throw new Error(t.message);salesTable.innerHTML="",t.length===0?salesTable.innerHTML="<tr><td colspan=9>No sales found.</td></tr>":t.forEach(t=>{const r=document.createElement("tr");r.innerHTML=`<td>${t.id}</td><td>${t.name}</td><td>$${parseFloat(t.price).toFixed(2)}</td><td>${t.quantity}</td><td>${t.category||"N/A"}</td><td>${t.barcode}</td><td>${t.client_name||"N/A"}</td><td>${t.sale_date}</td><td><button class="btn btn-sm btn-info me-1" onclick="viewSaleDetails(${t.sale_id})"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-success" onclick="generateInvoice(${t.sale_id})"><i class="fas fa-file-pdf"></i></button></td>`,salesTable.appendChild(r)})}).catch(t=>{console.error("Sales error:",t),showError(salesTable,t.message,9)})}function editProduct(e,t,r,n,i,o,a){document.getElementById("product_id").value=e,document.getElementById("name").value=t,document.getElementById("price").value=r,document.getElementById("quantity").value=n,document.getElementById("category_id").value=i,document.getElementById("description").value=o,document.getElementById("barcode").value=a,submitBtn.textContent="Update Product"}function deleteProduct(e){confirm("Are you sure you want to delete this product? This will also remove related sales records.")&&fetch("api.php?action=delete_product",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:e,csrf_token:csrfToken})}).then(e=>e.json()).then(t=>{if(t.status==="error")throw new Error(t.message);fetchProducts(),fetchLowStockProducts(),updateCsrfToken(),alert("Product deleted")}).catch(t=>{console.error("Delete product error:",t),alert(`Error: ${t.message}`)})}function viewSaleDetails(e){alert(`View details for sale ID: ${e}`)}productForm.addEventListener("submit",function(e){e.preventDefault(),submitBtn.disabled=!0;const t=new FormData(productForm);fetch(`api.php?action=${document.getElementById("product_id").value?"edit_product":"add_product"}`,{method:"POST",body:t}).then(e=>e.json()).then(e=>{if(submitBtn.disabled=!1,e.status==="error")throw new Error(e.message);productForm.reset(),submitBtn.textContent="Add Product",document.getElementById("product_id").value="",fetchProducts(),fetchLowStockProducts(),updateCsrfToken(),alert("Product saved")}).catch(e=>{console.error("Save product error:",e),alert(`Error: ${e.message}`),submitBtn.disabled=!1})}),clearBtn.addEventListener("click",function(){productForm.reset(),submitBtn.textContent="Add Product",document.getElementById("product_id").value=""}),searchInput.addEventListener("input",function(){clearTimeout(searchTimeout),searchTimeout=setTimeout(()=>{fetchProducts(this.value)},300)}),salesSearch.addEventListener("input",function(){clearTimeout(searchTimeout),searchTimeout=setTimeout(()=>{fetchSales(this.value)},300)}),importForm.addEventListener("submit",function(e){e.preventDefault();const t=new FormData(importForm);fetch("api.php?action=import_products_csv",{method:"POST",body:t}).then(e=>e.json()).then(e=>{if(e.status==="error")throw new Error(e.message);fetchProducts(),fetchLowStockProducts(),updateCsrfToken(),alert("CSV imported")}).catch(e=>{console.error("Import CSV error:",e),alert(`Error: ${e.message}`)})}),thresholdForm.addEventListener("submit",function(e){e.preventDefault();const t=parseInt(document.getElementById("low_stock_threshold").value);if(t<1){alert("Threshold must be at least 1");return}fetch("api.php?action=set_low_stock_threshold",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({threshold:t,csrf_token:csrfToken})}).then(e=>e.json()).then(e=>{if(e.status==="error")throw new Error(e.message);fetchProducts(),fetchLowStockProducts(),updateCsrfToken(),alert("Threshold updated"),hasAlerted=!1}).catch(e=>{console.error("Threshold error:",e),alert(`Error: ${e.message}`)})}),reportForm.addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("start_date").value,r=document.getElementById("end_date").value;new Date(t)>new Date(r)?alert("Start date cannot be after end date"):fetchSalesReport(t,r,!0)}),toggleScanner.addEventListener("click",function(){scannerActive?(Quagga.stop(),barcodeScanner.classList.add("d-none"),scannerActive=!1,toggleScanner.textContent="Start Scanner",scanResult.innerHTML=""):(barcodeScanner.classList.remove("d-none"),Quagga.init({inputStream:{name:"Live",type:"LiveStream",target:barcodeScanner,constraints:{width:640,height:480,facingMode:"environment"}},decoder:{readers:["ean_reader","upc_reader","code_128_reader"]}},function(e){e?(console.error("Quagga init error:",e),scanResult.innerHTML=`<p class="error">Error initializing scanner: ${e}</p>`):(Quagga.start(),scannerActive=!0,toggleScanner.textContent="Stop Scanner")}),Quagga.onDetected(function(e){const t=e.codeResult.code;fetch(`api.php?action=get_product_by_barcode&barcode=${encodeURIComponent(t)}`).then(e=>e.json()).then(e=>{scanResult.innerHTML=e.status==="success"?`<p class="success">Product Found:</p><p>ID: ${e.product.id}</p><p>Name: ${e.product.name}</p><p>Price: $${parseFloat(e.product.price).toFixed(2)}</p><p>Quantity: ${e.product.quantity}</p><p>Category: ${e.product.category_name||"N/A"}</p><p>Barcode: ${e.product.barcode}</p><p>Description: ${e.product.description||"N/A"}</p>`:`<p class="error">${e.message}</p>`}).catch(e=>{console.error("Barcode error:",e),scanResult.innerHTML=`<p class="error">Error fetching product: ${e}</p>`})}))}),fetchProducts(),fetchSales(),fetchLowStockProducts(),fetchSalesReport(document.getElementById("start_date").value,document.getElementById("end_date").value);